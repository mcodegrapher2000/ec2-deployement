name: Deploy to EC2

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SSH client
      run: sudo apt-get install -y openssh-client

   
    - name: Decode SSH Key
      run: |
        echo "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBcnhMd3RESHZhZEE1RXdtRTl6UnVSalE1WDhZUkdmRW9GYy8yQWU3L0JCdlZqMTBXCmJyMklLR3duTjVYYUVLQkhmZ2FVKzNuYWdqL2dkeVRXd01KMkdJK1lQaFh4SFdSbUtLdm1Rb1Bma25QUTJjbk0KYjBkMS9GcVh5ajZXeTV4SXkyaktKYlA5WVZ5V1BTM2xMZHlKNjNsWlJ6QnhidjM4b3BGNUg5L3ZwWnBIcXBCWgoyM01qYlZHVEp1TWhrOWtKRm1UYnA2OTY5RVEvYWlBUGdMMkVOLzdWQkRRSENFSFBBUXpWYk52NHZlSUlxWmkwCjRYRDgyRVVtUVhuMURqMHg0dWIwSnBSOWNieEw3dVFod0xCQmFTTHJKOVpnRmJoeFhjWm0wVHdpVFNxV21xWkwKQi9FdzY4UFVXeXF3aEdyMVdXUlBNeXZBZTEwRExyK2tPOWV1WVFJREFRQUJBb0lCQUNkZzlqMUJ3aDBsMWNDZgpjb1g4Q0JYSVoyTlFkTVpHQlFNcS9LV2dzVUdtVlJuakVVbWxYZnZobjh5VDZ6RzBLNENBVUlCai95OHUyUGxUCmt1NVdqeU9sSU5ST01TYXdUMzQwZEIxZjlpakYzaU11amNvMTQ2YjRaWTM3R0FZQ1NDbGdqNTk5WmEvQm1KVjQKUGtWYmhyWXRYRlJ6NC8vWUp6d1Z4bzNSMitCK2ZQQnRJR3BuVVM1UWt5RlBqZzdQdDNLeFhiYjlnOHdmbi94UApIYUsydmhDSGFPaXk0NDBRTnRJb2ZXd2I3S0pTRWQycU9NQ1IzaWdtYnk1aDcvcUtISGFKdDZvQXpIRzlIVkhCClFjVU9QYnRyUEZSK09Ud2Jhc1NCaDhlNHBBeWE1WHcwSk44c3llU3RqL3lXYzVQcEVFbTR6RUdWRU4zUnJTZUwKdTFQSjhBRUNnWUVBM0t3eTYxNmFoYlFxWnVFVDJNUHk1OC9WWkcwZlltRlZ2WUpDRklpS1BWV1J1UC9Pa2VFawpXY1QrOG1BenYzQ2gvditOMXhibC9CUVkxWmYyaFRZVm41ZCs5OU10STJJV21DQ3NQVStxcVFwK0lNTTI5R1JJCk0valBwNXZQdHNhZzhLMFRYeVZVckhKQzlvcEovamt5d2dIMkNoSG1SSXBhSGRUVWdwbE5Sb0VDZ1lFQXl4bjYKQXM1VnBSeEVubXpFcnpkV2dSaldheFZYcUpEdFcvN3BKZUtiYllVeHh4dytlNWk3SVhPMVpQVkNKZGpVZ0Q5Ygp2Q3hYS3l6UVJFaHpLSDZQSU1hUkJPMVZKTmM3S0Y4NEJhejBIRng1TkhqM2VVU2J3elJ2eE85dDJScWo4SVA1CmVDOFFrNm1JQW9za3ZGTk5HejJTQzZQaEptRHBhMjh4eDlkSE4rRUNnWUVBMkdTY1FpYXhERy9TTExTR2k4Z0wKQ0xyTG5RRk5CMkkvZStpaCtCUzB5dFNBWTVPbDgzTjkrL0dydCs0U2tLWllsUC94RFh6TTVsYW15NzJLNXJKVQpuZjBuYXNwUXR5UFcyRE1oODdXTnV0b3BPT04xbms1QVo0YVR5dDZGMzh3RHdqOVdnYlRQeFpMK2kxaXNtbmxvCmhzcjVoSUpzOWNWZC9XYlpSWUFqUVFFQ2dZQjhyV0tiYkZ5SThmUnhxR1dKQmhoMVFYRUc1V0FkVzNKS0lnNnYKc2c4bHlUa0llSjhtc2xoVnJia3gwNWthc0tPcVlycUdwbFdRYkg4aEc3U05yRHRpckdLRHVzbWt4dmRLemtFTwp3dUJMdEx5MjZIZEttMEpmTDRaWlIzMlFZOWsxb1Y1NFY3UCtZWGpienR6ck90dS9tQ2xhT2V6UjZYWUEvSTU3CmxmempJUUtCZ1FEQmpTQlh2dTdNTEFZYTVTb0ovS3R1NUI1QWNabGM5Yk9IdERGYnFXekVWZnlHOXlPVG11V1YKdUJMckl4K20rSU1GdGJzNFUvTkNYdFhtNCtnSjdYQVluY2NFdk4vNll6aWZLZHBMMnZWRk1XU3pUcFcxcW93OAprYUhuVnJtZ21hdGVrOVRDbmtweFQyMU9rRWRxaVM0bGVOdEJDUGpPeTJZZ2pVUk9uNWw1aHc9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQ==" | base64 --decode > /tmp/deploy_key.pem
        chmod 600 /tmp/deploy_key.pem
    - name: display
      run: cat /tmp/deploy_key.pem
  
    - name: Start SSH Agent and Add Key
      run: ssh-add /tmp/deploy_key.pem
  
    - name: Verify Added Key
      run: ssh-add -l


    - name: Add SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: /tmp/deploy_key.pem

    - name: Copy deploy script to EC2
      run: scp -o StrictHostKeyChecking=no deploy.sh ubuntu@44.201.138.227:/home/ubuntu/deploy.sh

    - name: Execute deploy script on EC2
      run: ssh -o StrictHostKeyChecking=no ubuntu@44.201.138.227 'bash /home/ubuntu/deploy.sh'
